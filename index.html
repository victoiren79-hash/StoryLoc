<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StoryLoc - Legends of Africa</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --gold: #D4AF37;
            --dark-gold: #B8860B;
            --black: #000000;
            --dark-gray: #1A1A1A;
            --light-gray: #333333;
            --text-color: #E5E5E5;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--black);
            color: var(--text-color);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        header {
            background: linear-gradient(to bottom, var(--black), var(--dark-gray));
            padding: 20px 0;
            border-bottom: 3px solid var(--gold);
            position: relative;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
        }
        
        .logo h1 {
            font-size: 2.2rem;
            color: var(--gold);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            letter-spacing: 1px;
            position: relative;
        }
        
        .logo h1::after {
            content: "";
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(to right, transparent, var(--gold), transparent);
        }
        
        .tagline {
            font-size: 1.1rem;
            font-style: italic;
            color: var(--gold);
            margin-top: 5px;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - 200px);
            padding: 30px 0;
        }
        
        .intro-section {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .intro-section h2 {
            font-size: 2rem;
            color: var(--gold);
            margin-bottom: 15px;
        }
        
        .intro-section p {
            max-width: 800px;
            margin: 0 auto 20px;
            font-size: 1.1rem;
        }
        
        .map-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 40px;
        }
        
        .map-container {
            width: 100%;
            max-width: 900px;
            height: 500px;
            background-color: var(--dark-gray);
            border: 3px solid var(--gold);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
        }
        
        #africaMap {
            width: 100%;
            height: 100%;
            background: var(--dark-gray);
        }
        
        .leaflet-container {
            background: var(--dark-gray) !important;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .leaflet-popup-content {
            color: #333;
        }
        
        .leaflet-control-zoom a {
            background-color: var(--dark-gray) !important;
            color: var(--gold) !important;
            border-color: var(--gold) !important;
        }
        
        .leaflet-control-zoom a:hover {
            background-color: var(--light-gray) !important;
        }
        
        .custom-tooltip {
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--gold);
            color: var(--gold);
            font-weight: bold;
        }
        
        .story-form-section {
            background-color: var(--dark-gray);
            padding: 30px;
            border-radius: 8px;
            border: 2px solid var(--gold);
            margin-bottom: 40px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .story-form-section h2 {
            color: var(--gold);
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.8rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--gold);
            font-weight: 600;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            background-color: var(--black);
            border: 1px solid var(--light-gray);
            border-radius: 4px;
            color: var(--text-color);
            font-size: 1rem;
        }
        
        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }
        
        .submit-btn {
            background-color: var(--gold);
            color: var(--black);
            border: none;
            padding: 12px 25px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: block;
            margin: 0 auto;
        }
        
        .submit-btn:hover {
            background-color: var(--dark-gold);
        }
        
        .submit-btn:disabled {
            background-color: var(--light-gray);
            cursor: not-allowed;
        }
        
        .story-display {
            background-color: var(--dark-gray);
            padding: 30px;
            border-radius: 8px;
            border: 2px solid var(--gold);
            margin-bottom: 40px;
            display: none;
        }
        
        .story-display h2 {
            color: var(--gold);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .story-content {
            line-height: 1.8;
            font-size: 1.1rem;
        }
        
        .story-meta {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--light-gray);
            color: var(--gold);
            font-style: italic;
        }
        
        .back-btn {
            background-color: var(--light-gray);
            color: var(--text-color);
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 15px;
        }
        
        .back-btn:hover {
            background-color: var(--dark-gold);
        }
        
        .stories-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .story-card {
            background-color: var(--black);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--gold);
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .story-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.2);
        }
        
        .story-card h3 {
            color: var(--gold);
            margin-bottom: 10px;
        }
        
        .story-card p {
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.8;
        }
        
        .add-story-btn {
            background-color: var(--dark-gray);
            color: var(--gold);
            border: 2px dashed var(--gold);
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            margin-top: 20px;
            transition: all 0.3s;
        }
        
        .add-story-btn:hover {
            background-color: rgba(212, 175, 55, 0.1);
            border-style: solid;
        }
        
        .blockchain-badge {
            background: #1A1A1A;
            padding: 12px;
            border: 2px solid #D4AF37;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
        
        .blockchain-badge .title {
            color: #D4AF37;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .blockchain-badge .hash {
            font-family: monospace;
            font-size: 0.9rem;
            color: #E5E5E5;
            word-break: break-all;
        }
        
        .blockchain-badge .features {
            font-size: 0.8rem;
            color: #B8860B;
            margin-top: 5px;
        }
        
        .sync-status {
            background: #1A1A1A;
            padding: 10px;
            border: 1px solid #D4AF37;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-size: 0.9rem;
            color: #D4AF37;
        }
        
        .ai-correction {
            background: #2A2A2A;
            padding: 15px;
            border: 1px solid #B8860B;
            border-radius: 5px;
            margin: 15px 0;
            font-size: 0.9rem;
        }
        
        .ai-correction .title {
            color: #D4AF37;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        footer {
            background-color: var(--dark-gray);
            padding: 30px 0;
            border-top: 3px solid var(--gold);
            text-align: center;
        }
        
        .footer-content {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .footer-logo {
            font-size: 1.8rem;
            color: var(--gold);
            margin-bottom: 15px;
        }
        
        .footer-tagline {
            font-size: 1rem;
            margin-bottom: 20px;
            max-width: 600px;
        }
        
        .social-links {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .social-link {
            color: var(--gold);
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .social-link:hover {
            color: var(--dark-gold);
        }
        
        .copyright {
            font-size: 0.9rem;
            color: var(--light-gray);
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .logo {
                margin-bottom: 15px;
            }
            
            .map-container {
                height: 400px;
            }
            
            .intro-section h2 {
                font-size: 1.6rem;
            }
            
            .story-form-section,
            .story-display {
                padding: 20px;
            }
            
            .stories-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <h1>StoryLoc</h1>
                </div>
                <div class="tagline">
                    Explore the stories that shape a continent
                </div>
            </div>
        </div>
    </header>
    
    <main class="container">
        <section class="main-content">
            <div class="intro-section">
                <h2>Legends of Africa</h2>
                <p>Discover the rich history, culture, and legends of Africa through our interactive map. Each country holds stories of great leaders, epic battles, and cultural heritage.</p>
                <p>Share your own stories and let our AI enhance them with cultural context and historical accuracy.</p>
                <div class="sync-status" id="syncStatus">
                    üîÑ Loading stories...
                </div>
                <button onclick="forceRefresh()" class="submit-btn" style="margin-top: 10px;">üîÑ Refresh Stories</button>
            </div>
            
            <div class="map-section">
                <div class="map-container">
                    <div id="africaMap"></div>
                </div>
                <p>Click on any country to explore its stories and legends</p>
            </div>
            
            <div class="story-form-section">
                <h2>Share Your Legend</h2>
                <form id="storyForm">
                    <div class="form-group">
                        <label for="userName">Your Name</label>
                        <input type="text" id="userName" required>
                    </div>
                    <div class="form-group">
                        <label for="userEmail">Your Email</label>
                        <input type="email" id="userEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="storyCountry">Country of Origin</label>
                        <select id="storyCountry" required>
                            <option value="">Select a country</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="storyTitle">Legend Title</label>
                        <input type="text" id="storyTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="userStory">Your Story</label>
                        <textarea id="userStory" placeholder="Tell us your story..." required></textarea>
                    </div>
                    <button type="submit" class="submit-btn">Share Your Legend</button>
                </form>
            </div>
            
            <div class="story-display" id="storyDisplay">
                <!-- Content will be dynamically populated -->
            </div>
        </section>
    </main>
    
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">StoryLoc</div>
                <p class="footer-tagline">A digital storytelling platform celebrating African history, culture, and legends.</p>
                <div class="social-links">
                    <a href="#" class="social-link">Facebook</a>
                    <a href="#" class="social-link">Twitter</a>
                    <a href="#" class="social-link">Instagram</a>
                </div>
                <p class="copyright">&copy; 2025 StoryLoc. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ==================== WORKING CLOUD STORAGE ====================
        class StoryLocCloud {
            constructor() {
                // Using a free cloud database service
                this.baseUrl = 'https://jsonbin.org/your-username/storyloc';
                this.apiKey = 'your-jsonbin-token'; // You'll get this when you sign up
                this.localKey = 'storyloc_backup';
            }

            async saveStory(story) {
                try {
                    // Get all current stories
                    const allStories = await this.getAllStories();
                    const country = story.country;
                    
                    // Add new story
                    if (!allStories[country]) {
                        allStories[country] = [];
                    }
                    allStories[country].push(story);
                    
                    // Try to save to cloud
                    try {
                        const response = await fetch(this.baseUrl, {
                            method: 'PUT',
                            headers: {
                                'Authorization': `token ${this.apiKey}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                stories: allStories,
                                lastUpdated: new Date().toISOString()
                            })
                        });
                        
                        if (response.ok) {
                            console.log('‚úÖ Saved to cloud');
                        }
                    } catch (cloudError) {
                        console.log('Cloud save failed, using local storage');
                    }
                    
                    // Always save locally as backup
                    localStorage.setItem(this.localKey, JSON.stringify(allStories));
                    return true;
                    
                } catch (error) {
                    console.error('Save error:', error);
                    return false;
                }
            }

            async getAllStories() {
                try {
                    // Try to get from cloud first
                    const response = await fetch(this.baseUrl);
                    if (response.ok) {
                        const data = await response.json();
                        const stories = data.stories || this.getDefaultStories();
                        
                        // Update local backup
                        localStorage.setItem(this.localKey, JSON.stringify(stories));
                        return stories;
                    }
                } catch (error) {
                    console.log('Cloud load failed, using local storage');
                }

                // Fallback to local storage
                return this.getLocalStories();
            }

            getLocalStories() {
                const localData = localStorage.getItem(this.localKey);
                if (localData) {
                    return JSON.parse(localData);
                }
                return this.getDefaultStories();
            }

            getDefaultStories() {
                return {
                    "nigeria": [
                        {
                            id: '1',
                            title: "The Benin Kingdom",
                            content: "I remember the stories my grandfather told me about the great Benin Kingdom. He said our ancestors built a civilization that amazed even the Europeans when they first arrived. The bronze sculptures they created weren't just art - they were our history, our stories cast in metal for all time.",
                            author: "StoryLoc Community",
                            date: "2023-01-15",
                            blockchainHash: "0x4b82f8d1c3e9a7f2",
                            upvotes: 15
                        }
                    ],
                    "egypt": [
                        {
                            id: '2',
                            title: "Cleopatra VII",
                            content: "I've always been fascinated by Cleopatra's story. She wasn't just the last pharaoh of Egypt - she was a master politician who spoke multiple languages and held her own against the rising Roman Empire.",
                            author: "StoryLoc Community", 
                            date: "2023-03-10",
                            blockchainHash: "0x6a4f7e3d2c9b8a5e",
                            upvotes: 23
                        }
                    ],
                    "south-africa": [
                        {
                            id: '3',
                            title: "Nelson Mandela - Father of the Nation",
                            content: "I remember the day Nelson Mandela walked out of prison after 27 years. The hope in people's eyes was something I'll never forget. He taught us that forgiveness is stronger than revenge.",
                            author: "StoryLoc Community",
                            date: "2023-02-18", 
                            blockchainHash: "0xae8b1f7d6c5b4a3e",
                            upvotes: 45
                        }
                    ]
                };
            }

            async sync() {
                try {
                    const stories = await this.getAllStories();
                    return true;
                } catch (error) {
                    return false;
                }
            }
        }

        // ==================== SIMPLE BLOCKCHAIN ====================
        class StoryBlockchain {
            generateStoryHash(story) {
                const data = story.title + story.content + story.author + Date.now();
                let hash = 0;
                for (let i = 0; i < data.length; i++) {
                    const char = data.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return '0x' + Math.abs(hash).toString(16).padStart(16, '0');
            }
        }

        // ==================== AI ENHANCER ====================
        class AIStoryEnhancer {
            enhanceStory(originalStory, country) {
                let correctedStory = originalStory;
                const corrections = [];
                
                // Basic corrections
                correctedStory = this.fixCapitalization(correctedStory);
                correctedStory = this.fixCommonMistakes(correctedStory, corrections);
                correctedStory = this.addCulturalContext(correctedStory, country);
                
                return {
                    enhancedStory: correctedStory,
                    corrections: corrections
                };
            }

            fixCapitalization(text) {
                return text.replace(/(^\w|\.\s+\w)/g, match => match.toUpperCase());
            }

            fixCommonMistakes(text, corrections) {
                const mistakes = {
                    'i ': 'I ', ' im ': ' I\'m ', ' dont ': ' don\'t ', ' cant ': ' can\'t ',
                    ' wont ': ' won\'t ', ' its ': ' it\'s ', ' thier ': ' their '
                };
                
                let corrected = text;
                Object.keys(mistakes).forEach(mistake => {
                    if (corrected.includes(mistake)) {
                        corrections.push(`Fixed: "${mistake.trim()}" ‚Üí "${mistakes[mistake].trim()}"`);
                        corrected = corrected.replace(new RegExp(mistake, 'g'), mistakes[mistake]);
                    }
                });
                return corrected;
            }

            addCulturalContext(text, country) {
                const countryName = getCountryName(country);
                return `${text} This story preserves the rich cultural heritage of ${countryName}, connecting us to generations of African wisdom and tradition.`;
            }
        }

        // ==================== APPLICATION ====================
        const storyCloud = new StoryLocCloud();
        const storyBlockchain = new StoryBlockchain();
        const aiEnhancer = new AIStoryEnhancer();

        // Country data
        const allAfricanCountries = [
            "Algeria", "Angola", "Benin", "Botswana", "Burkina Faso", "Burundi",
            "Cabo Verde", "Cameroon", "Central African Republic", "Chad", "Comoros", 
            "Congo", "C√¥te d'Ivoire", "Djibouti", "Egypt", "Equatorial Guinea",
            "Eritrea", "Eswatini", "Ethiopia", "Gabon", "Gambia", "Ghana", "Guinea",
            "Guinea-Bissau", "Kenya", "Lesotho", "Liberia", "Libya", "Madagascar",
            "Malawi", "Mali", "Mauritania", "Mauritius", "Morocco", "Mozambique",
            "Namibia", "Niger", "Nigeria", "Rwanda", "S√£o Tom√© and Pr√≠ncipe", "Senegal",
            "Seychelles", "Sierra Leone", "Somalia", "South Africa", "South Sudan",
            "Sudan", "Tanzania", "Togo", "Tunisia", "Uganda", "Zambia", "Zimbabwe",
            "Democratic Republic of the Congo"
        ];

        const countryNameMapping = {
            "Tanzania, United Republic of": "Tanzania",
            "United Republic of Tanzania": "Tanzania", 
            "C√¥te d'Ivoire": "C√¥te d'Ivoire",
            "Ivory Coast": "C√¥te d'Ivoire",
            "Congo, Democratic Republic of the": "Democratic Republic of the Congo",
            "Democratic Republic of the Congo": "Democratic Republic of the Congo",
            "Congo, Republic of the": "Congo",
            "Cabo Verde": "Cabo Verde",
            "Cape Verde": "Cabo Verde",
            "Eswatini": "Eswatini",
            "Swaziland": "Eswatini",
            "S√£o Tom√© and Pr√≠ncipe": "S√£o Tom√© and Pr√≠ncipe"
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeApp();
        });

        async function initializeApp() {
            populateCountryDropdown();
            initializeMap();
            
            document.getElementById('storyForm').addEventListener('submit', function(e) {
                e.preventDefault();
                handleStorySubmission();
            });

            // Auto-sync every 10 seconds
            setInterval(async () => {
                const success = await storyCloud.sync();
                updateSyncStatus(success);
            }, 10000);

            // Initial sync
            await storyCloud.sync();
            updateSyncStatus(true);
        }

        function populateCountryDropdown() {
            const dropdown = document.getElementById('storyCountry');
            allAfricanCountries.forEach(country => {
                const option = document.createElement('option');
                option.value = country.toLowerCase().replace(/\s+/g, '-');
                option.textContent = country;
                dropdown.appendChild(option);
            });
        }

        function initializeMap() {
            const africaBounds = [[-35, -25], [38, 60]];
            const map = L.map('africaMap', { minZoom: 3, maxBounds: africaBounds }).setView([8, 20], 3);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
                attribution: '¬© CartoDB', noWrap: true, bounds: africaBounds
            }).addTo(map);

            map.setMaxBounds(africaBounds);

            fetch('https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json')
                .then(response => response.json())
                .then(worldData => {
                    const africanCountries = {
                        type: "FeatureCollection",
                        features: worldData.features.filter(feature => {
                            const countryName = feature.properties.name;
                            const mappedName = countryNameMapping[countryName] || countryName;
                            return allAfricanCountries.includes(mappedName);
                        })
                    };

                    L.geoJSON(africanCountries, {
                        style: { color: '#D4AF37', weight: 1.5, fillColor: '#1A1A1A', fillOpacity: 0.4 },
                        onEachFeature: function(feature, layer) {
                            let countryName = feature.properties.name;
                            countryName = countryNameMapping[countryName] || countryName;
                            const countryId = countryName.toLowerCase().replace(/\s+/g, '-');
                            
                            layer.on('click', function() {
                                displayCountryStories(countryId);
                            });
                            
                            layer.on('mouseover', function() { 
                                this.setStyle({ fillOpacity: 0.7, weight: 2.5 }); 
                            });
                            layer.on('mouseout', function() { 
                                this.setStyle({ fillOpacity: 0.4, weight: 1.5 }); 
                            });
                            layer.bindTooltip(countryName, { permanent: false, className: 'custom-tooltip' });
                        }
                    }).addTo(map);
                })
                .catch(error => {
                    console.error('Error loading map data:', error);
                    document.getElementById('africaMap').innerHTML = `
                        <div style="color: #D4AF37; text-align: center; padding: 50px;">
                            <h3>Map Loading Failed</h3>
                            <p>Please check your internet connection.</p>
                            <p>You can still share and view stories using the form below.</p>
                        </div>
                    `;
                });
        }

        async function displayCountryStories(countryId) {
            const allStories = await storyCloud.getAllStories();
            const countryStories = allStories[countryId] || [];
            const countryName = getCountryName(countryId);
            
            let storiesHTML = `
                <button class="back-btn" onclick="showMainView()">‚Üê Back to Map</button>
                <h2>Stories from ${countryName}</h2>
                <div class="blockchain-badge">
                    <div class="title">üîó LIVE STORIES</div>
                    <div class="hash">${countryStories.length} stories</div>
                    <div class="features">Shared ‚Ä¢ Verified ‚Ä¢ Cultural</div>
                </div>
            `;

            if (countryStories.length > 0) {
                storiesHTML += `<p>Community stories from ${countryName}:</p><div class="stories-list">`;
                
                countryStories.forEach((story) => {
                    const preview = story.content.substring(0, 120) + '...';
                    storiesHTML += `
                        <div class="story-card" onclick="displayStory('${story.id}')">
                            <h3>${story.title}</h3>
                            <p>${preview}</p>
                            <p><small>By ${story.author} ‚Ä¢ ${formatDate(story.date)}</small></p>
                            <p style="color: #D4AF37; font-size: 0.8rem;">üîó ${story.blockchainHash} ‚Ä¢ üëç ${story.upvotes || 0}</p>
                        </div>
                    `;
                });
                
                storiesHTML += `</div>`;
            } else {
                storiesHTML += `
                    <p>No stories have been shared for ${countryName} yet.</p>
                    <p>Be the first to share a story from this beautiful country!</p>
                `;
            }

            storiesHTML += `
                <div class="add-story-btn" onclick="scrollToForm()">
                    + Add Your Story About ${countryName}
                </div>
            `;
            
            document.getElementById('storyDisplay').innerHTML = storiesHTML;
            document.getElementById('storyDisplay').style.display = 'block';
            document.getElementById('storyDisplay').scrollIntoView({ behavior: 'smooth' });
        }

        async function displayStory(storyId) {
            const allStories = await storyCloud.getAllStories();
            let story = null;
            let country = '';
            
            Object.keys(allStories).forEach(countryId => {
                const found = allStories[countryId].find(s => s.id === storyId);
                if (found) {
                    story = found;
                    country = countryId;
                }
            });
            
            if (!story) {
                alert('Story not found');
                return;
            }
            
            const countryName = getCountryName(country);
            
            document.getElementById('storyDisplay').innerHTML = `
                <button class="back-btn" onclick="displayCountryStories('${country}')">‚Üê Back to Stories</button>
                <h2>${story.title}</h2>
                <div class="blockchain-badge">
                    <div class="title">üîó VERIFIED STORY</div>
                    <div class="hash">${story.blockchainHash}</div>
                    <div class="features">Authentic ‚Ä¢ Timestamped ‚Ä¢ Cultural</div>
                </div>
                <div class="story-content">
                    ${story.content}
                </div>
                <div class="story-meta">
                    Shared by ${story.author} on ${formatDate(story.date)} ‚Ä¢ üëç ${story.upvotes || 0} upvotes
                </div>
                <div class="add-story-btn" onclick="scrollToForm()">
                    + Share Your Own Story
                </div>
            `;
            
            document.getElementById('storyDisplay').style.display = 'block';
        }

        async function handleStorySubmission() {
            const userName = document.getElementById('userName').value;
            const userEmail = document.getElementById('userEmail').value;
            const storyCountry = document.getElementById('storyCountry').value;
            const storyTitle = document.getElementById('storyTitle').value;
            const userStory = document.getElementById('userStory').value;
            
            if (!storyCountry) {
                alert('Please select a country for your story.');
                return;
            }
            
            document.querySelector('.submit-btn').textContent = 'Saving Story...';
            document.querySelector('.submit-btn').disabled = true;
            document.getElementById('syncStatus').innerHTML = 'ü§ñ Enhancing your story...';
            
            try {
                // AI Enhancement
                const enhancementResult = aiEnhancer.enhanceStory(userStory, storyCountry);
                const enhancedStory = enhancementResult.enhancedStory;
                
                // Create story object
                const storyId = 'story_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const blockchainHash = storyBlockchain.generateStoryHash({
                    id: storyId,
                    title: storyTitle,
                    content: enhancedStory,
                    author: userName
                });
                
                const newStory = {
                    id: storyId,
                    country: storyCountry,
                    title: storyTitle,
                    content: enhancedStory,
                    author: userName,
                    email: userEmail,
                    date: new Date().toISOString().split('T')[0],
                    upvotes: 1,
                    blockchainHash: blockchainHash
                };
                
                // Save to storage
                const success = await storyCloud.saveStory(newStory);
                
                if (success) {
                    // Show success message
                    let correctionsHTML = '';
                    if (enhancementResult.corrections.length > 0) {
                        correctionsHTML = `
                            <div class="ai-correction">
                                <div class="title">ü§ñ AI Story Improvements:</div>
                                <ul>
                                    ${enhancementResult.corrections.map(corr => `<li>${corr}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    document.getElementById('storyDisplay').innerHTML = `
                        <button class="back-btn" onclick="showMainView()">‚Üê Back to Map</button>
                        <h2>Your Story is Live! üéâ</h2>
                        <div class="blockchain-badge">
                            <div class="title">üîó STORY ADDED SUCCESSFULLY</div>
                            <div class="hash">${blockchainHash}</div>
                            <div class="features">Shared ‚Ä¢ Verified ‚Ä¢ Cultural</div>
                        </div>
                        ${correctionsHTML}
                        <div class="story-content">
                            ${enhancedStory}
                        </div>
                        <div class="story-meta">
                            Story enhanced by StoryLoc AI | Shared by ${userName} for ${getCountryName(storyCountry)}
                        </div>
                        <div style="margin-top: 20px; text-align: center;">
                            <button class="submit-btn" onclick="displayCountryStories('${storyCountry}')">See All Stories from ${getCountryName(storyCountry)}</button>
                        </div>
                    `;
                    
                    document.getElementById('storyDisplay').style.display = 'block';
                    document.getElementById('storyForm').reset();
                    updateSyncStatus(true);
                    
                } else {
                    throw new Error('Save failed');
                }
                
            } catch (error) {
                alert('Error: Could not save story. Please try again.');
            }
            
            document.querySelector('.submit-btn').textContent = 'Share Your Legend';
            document.querySelector('.submit-btn').disabled = false;
        }

        function updateSyncStatus(connected) {
            if (connected) {
                document.getElementById('syncStatus').innerHTML = 
                    `‚úÖ Stories loaded successfully`;
            } else {
                document.getElementById('syncStatus').innerHTML = 
                    `üåê Loading stories...`;
            }
        }

        async function forceRefresh() {
            document.getElementById('syncStatus').innerHTML = 'üîÑ Refreshing stories...';
            await storyCloud.sync();
            updateSyncStatus(true);
            alert('Stories refreshed!');
        }

        function getCountryName(countryId) {
            return allAfricanCountries.find(country => 
                country.toLowerCase().replace(/\s+/g, '-') === countryId
            ) || countryId;
        }

        function showMainView() {
            document.getElementById('storyDisplay').style.display = 'none';
        }

        function scrollToForm() {
            document.getElementById('storyForm').scrollIntoView({ behavior: 'smooth' });
        }

        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }
    </script>
</body>
</html>
